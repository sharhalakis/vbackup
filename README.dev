Simple backup
=============

Tree:
=====

The installation layout should comply with the latest FHS (2.3 as of Nov 2006).
Everything different than that should be reported as bug.

${bindir}/			The vbackup program
	
${sysconfdir}/
	vbackup/
		rc.d/		Backup configurations
		backup.daily/	Links to appropriate rc.d scripts
			vbackup.conf	Per backup global configuration file
		backup.weekly/	....
		backup.monthly/	....
		

${datadir}/
	vbackup/
		bin/		Core scripts (run) used by vbackup
				(They are standalone scripts)
		helpers/	Helper scripts (not standalone)
		scripts/	The backup scripts
		wizard/		Wizard configuration files

${docdir}/
	vbackup/		Documentation
		samples/	Sample configurations


Backup scripts:
===============

Each backup script must provide:

functions:
----------
do_help()		A function to display help and return
do_check_conf()		Check whether all configuration variables are ok
			Return: 0: OK, 1: Error
			May display error messages
do_run()		Do the backup

variables:
----------
NAME			The script name ("psql")
VERSION			The script version ("1.0.0")
DESC			A short description ("Backup a postgresql database")
COPYRIGHT		Copyright ("Copyright (c) 2006 Harhalakis Stefanos")
LICENCE			The license of the script ("GPLv2")
CONTACT			A contact email for bugreports etc ("v13@v13.gr")

It may expect:
--------------
  * If the configuration file includes a DESTDIR options, it will be
    prepended with the DESTDIR0 prefix. It will also be transformed
    by changed %X% variables (for example %D1%)
  * A variable named ABORT is set to 1 if a script previously exited with
    error code 2 (see bellow). Most scripts should abort with exit code 0
    when they detect this. For example: a script that checks for free space
    may exit with error code 2. The ABORT variable will be set automatically.
    All backup scripts must detect this and do nothing. The umount script
    will ignore this and actually try to umount the directory.

It must return (from each function):
------------------------------------
0	Everything were OK
1	Error occured - continue backups
2	Error occured - abort backup sequence
3	Error occured - force abort of backup sequence

Notes:
  * When a script returns 2, the flag ABORT is set to 1. This is
    checked by backup scripts and they will not do anything at all.
    Scripts like umount may ignore this and umount the directory
  * When a script returns 3, the backup is immediately aborted.
    This sould be used by scripts like mount

Configuration files:
====================

Some configuration files may include a DESTDIR directive.
It may contain the following special sequences:

 * '%D1%' which will be replaced by YYMMDD of the current date
   Example: /tmp/backups/filesystem/%D1%
   will be converted to: /tmp/backups/filesystem/061117 (as of 17 Nov 2006)

(to be extended with other formats)

Configuration directives:
=========================

Configuration directives should preserve the same name across scripts  when
possible. Common directives are (using regexp):

 DESTDIR	Where to backup to
 DATABASES	The databases to backup, for DB backups
 PASSWORD	To hold a password
 .*USER		To hold a username (examples: PGUSER, MYUSER etc..)
 
NOTE! The directive USER should never be used. I repeat NEVER USE THE USER
DIRECTIVE! Same thing applies for other well known directives that may be
set by sh/bash.

Common configuration variables:
===============================

Common configuration variables are variables that are set in vbackup.conf
or in other configuration files. The vbackup.conf entry is the main one
but it may be overriden by individual configuration files.

 COMPRESS	Whether to compress the backup or not (yes/no, on/off, 1/0)

Wizard:
=======
Inside the wizard dir, each script may place a configuration file. This file
will describe a wizard step for initial configuration creation.

Each wizard configuration file includes:
NAME="the name of the configuration script"
PRI="Priority of configuration file"

w_do_ask()
{
  A function that will be called to ask for configuration parameters.
  This function may be called multiple times to answer different questions.
  The first argument mantates the question to me asked
  Initialy, this function is called with "ENABLE" as the first argument.
  All capital letter names should be reserved for vbackup usage. This function
  must set the variable ASK_NEXT to "" whenever the series of questions is
  finished, or to a name that will be passed as the first argument to the
  next function call.

  The last function call must return 0 to indicate that this method is
  active or 1 to indicate that it is not

  Example call tree:
  do_ask ENABLE ==> Set ASK_NEXT=path
  do_ask path ==> Set ASK_NEXT=level
  do_ask level ==> Set ASK_NEXT="", return code=0
  finished asking questions, method is enabled

  This function may also write to temporary file $CFG
  echo 'DIRS="/tmp"' > $CFG
  echo '# Comment' > $CFG

  This file will be available when w_get_config() is called.
  Typically, this should contain the majority of the configuration options
  except from backup level related options.
}

w_get_config()
{
  A function that should print to its stdout the configuration file
  The first argument is a number that indicates a backup level. This should
  be used whenever backup levels are supported (or to enable-disable a method
  for a specific backup level).

  This function may produce empty output to indicate that it should be
  disabled at the current backup level.
}


